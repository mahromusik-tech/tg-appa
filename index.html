<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TON Casino Online</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --accent: #f5c518;
            --text: #ffffff;
            --red: #e53935;
            --black: #212121;
            --green: #43a047;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            user-select: none; overflow-x: hidden;
        }
        /* –•–µ–¥–µ—Ä */
        .header {
            padding: 15px 20px; background: var(--card-bg);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .balance-box {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 20px;
        }
        .coin-icon { color: var(--accent); font-size: 18px; }
        .balance-val { font-weight: bold; font-size: 16px; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav {
            position: fixed; bottom: 0; width: 100%; background: var(--card-bg);
            display: flex; justify-content: space-around; padding: 10px 0 20px 0;
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            opacity: 0.5; font-size: 10px; gap: 4px;
        }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .nav-icon { font-size: 20px; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –†—É–ª–µ—Ç–∫–∞ */
        .roulette-wrapper {
            width: 100%; overflow: hidden; position: relative;
            background: #000; height: 80px; border-radius: 8px;
            margin: 20px 0; border: 2px solid #333;
        }
        .roulette-strip {
            display: flex; height: 100%;
            transition: transform 4s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        .r-card {
            min-width: 60px; height: 100%; display: flex;
            justify-content: center; align-items: center;
            font-weight: bold; font-size: 18px; color: white;
            border-right: 1px solid rgba(0,0,0,0.2);
        }
        .bg-red { background: var(--red); }
        .bg-black { background: var(--black); }
        .bg-green { background: var(--green); }
        .pointer {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 4px; height: 100%; background: var(--accent); z-index: 10;
            box-shadow: 0 0 10px var(--accent);
        }

        /* –°—Ç–∞–≤–∫–∏ */
        .bet-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .bet-input {
            flex: 1; background: var(--card-bg); border: 1px solid #333;
            color: white; padding: 12px; border-radius: 8px;
            text-align: center; font-size: 18px;
        }
        .bet-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn-bet {
            padding: 15px; border: none; border-radius: 8px; color: white;
            font-weight: bold; cursor: pointer; position: relative; overflow: hidden;
        }
        .btn-bet:active { transform: scale(0.96); }
        .x-val { font-size: 10px; opacity: 0.8; display: block; }

        /* –ú–µ–Ω—é */
        .game-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px;
            margin-bottom: 15px; display: flex; align-items: center; gap: 15px;
        }
        .game-icon { font-size: 30px; }
        .tag-soon { background: #333; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-left: auto; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-header { text-align: center; margin-bottom: 30px; }
        .avatar {
            width: 80px; height: 80px; background: #333; border-radius: 50%;
            margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 30px;
        }
        .stat-row {
            display: flex; justify-content: space-between; padding: 15px;
            background: var(--card-bg); margin-bottom: 2px;
        }
        .loader { text-align: center; padding: 20px; color: var(--accent); }
    </style>
</head>
<body>

    <div class="header">
        <div style="font-weight: 900; letter-spacing: 1px;">TON CASINO</div>
        <div class="balance-box">
            <span class="coin-icon">ü™ô</span>
            <span class="balance-val" id="balance">...</span>
        </div>
    </div>

    <!-- –ú–ï–ù–Æ -->
    <div id="screen-menu" class="screen">
        <h3>–í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞</h3>
        <div class="game-card" onclick="switchScreen('roulette')">
            <div class="game-icon">üé∞</div>
            <div><h4>–†—É–ª–µ—Ç–∫–∞</h4><p style="font-size:12px; opacity:0.6">–ö–ª–∞—Å—Å–∏–∫–∞</p></div>
        </div>
        <div class="game-card" style="opacity: 0.7;">
            <div class="game-icon">üí£</div>
            <div><h4>Mines</h4><p style="font-size:12px; opacity:0.6">–°–∞–ø–µ—Ä</p></div>
            <div class="tag-soon">–°–ö–û–†–û</div>
        </div>
    </div>

    <!-- –†–£–õ–ï–¢–ö–ê -->
    <div id="screen-roulette" class="screen active">
        <button onclick="switchScreen('menu')" style="background:none; border:none; color:gray; margin-bottom:10px;">‚Üê –ú–µ–Ω—é</button>
        <div class="roulette-wrapper">
            <div class="pointer"></div>
            <div class="roulette-strip" id="strip"></div>
        </div>
        <div class="bet-controls">
            <input type="number" id="bet-amount" class="bet-input" value="10" placeholder="–°—É–º–º–∞">
            <button onclick="setMaxBet()" style="background:#333; border:none; color:white; border-radius:8px; padding:0 10px;">MAX</button>
        </div>
        <div class="bet-actions">
            <button class="btn-bet bg-red" onclick="spin('red')" id="btn-red"><span>RED</span> <span class="x-val">x2</span></button>
            <button class="btn-bet bg-green" onclick="spin('green')" id="btn-green"><span>ZERO</span> <span class="x-val">x14</span></button>
            <button class="btn-bet bg-black" onclick="spin('black')" id="btn-black"><span>BLACK</span> <span class="x-val">x2</span></button>
        </div>
        <div style="margin-top: 20px; text-align: center; font-size: 12px; color: gray;">–ò—Å—Ç–æ—Ä–∏—è: <span id="history"></span></div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="screen-profile" class="screen">
        <div class="profile-header">
            <div class="avatar">üë§</div>
            <h2 id="username">–ò–≥—Ä–æ–∫</h2>
            <p style="opacity: 0.5; font-size: 12px;" id="userid">ID: ...</p>
        </div>
        <div class="stat-row"><span>–ë–∞–ª–∞–Ω—Å (Server)</span><span style="color: var(--accent); font-weight: bold;" id="profile-balance">...</span></div>
        <div style="text-align:center; margin-top:20px; opacity:0.5; font-size:12px">–î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å –ë–î</div>
    </div>

    <!-- –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
    <div class="nav">
        <div class="nav-item" onclick="switchScreen('menu', this)"><span class="nav-icon">üéÆ</span><span>–ò–≥—Ä—ã</span></div>
        <div class="nav-item active" onclick="switchScreen('roulette', this)"><span class="nav-icon">üé∞</span><span>–†—É–ª–µ—Ç–∫–∞</span></div>
        <div class="nav-item" onclick="switchScreen('profile', this)"><span class="nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script>
        // !!! –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ù–ê –¢–í–û–ô –§–ê–ô–õ API.PHP !!!
        const API_URL = './api.php'; 

        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe.user || { id: 111111, first_name: 'Test User' };
        let currentBalance = 0;
        let isSpinning = false;

        // --- –°–ï–¢–¨ ---
        async function apiRequest(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: action,
                        tg_id: user.id,
                        username: user.first_name,
                        ...data
                    })
                });
                return await response.json();
            } catch (e) {
                console.error(e);
                tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º!");
                return null;
            }
        }

        async function initGame() {
            document.getElementById('username').innerText = user.first_name;
            document.getElementById('userid').innerText = `ID: ${user.id}`;
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞
            const res = await apiRequest('get_user');
            if (res && res.balance !== undefined) {
                currentBalance = res.balance;
                updateUI();
            }
            generateStrip();
        }

        async function syncBalance() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            await apiRequest('update_balance', { balance: currentBalance });
        }

        // --- –ò–ì–†–ê ---
        const CARD_WIDTH = 60;

        function generateStrip() {
            const strip = document.getElementById('strip');
            let html = '';
            for(let i=0; i<100; i++) {
                const num = Math.floor(Math.random() * 15);
                let color = (num === 0) ? 'bg-green' : (num % 2 === 0 ? 'bg-red' : 'bg-black');
                html += `<div class="r-card ${color}" id="card-${i}">${num}</div>`;
            }
            strip.innerHTML = html;
        }

        function spin(choice) {
            if(isSpinning) return;
            const bet = parseInt(document.getElementById('bet-amount').value);
            
            if(isNaN(bet) || bet <= 0) return tg.showAlert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞");
            if(bet > currentBalance) return tg.showAlert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥");

            currentBalance -= bet;
            updateUI();
            isSpinning = true;
            tg.HapticFeedback.impactOccurred('light');

            // –õ–æ–≥–∏–∫–∞ –≤—ã–∏–≥—Ä—ã—à–∞
            const winNum = Math.floor(Math.random() * 15);
            let winColor = (winNum === 0) ? 'green' : (winNum % 2 === 0 ? 'red' : 'black');

            // –ê–Ω–∏–º–∞—Ü–∏—è
            let targetIndex = 75 + Math.floor(Math.random() * 10);
            const targetCard = document.getElementById(`card-${targetIndex}`);
            targetCard.innerText = winNum;
            targetCard.className = `r-card bg-${winColor === 'red' ? 'red' : (winColor === 'green' ? 'green' : 'black')}`;

            const wrapperWidth = document.querySelector('.roulette-wrapper').offsetWidth;
            const offset = (targetIndex * CARD_WIDTH) - (wrapperWidth / 2) + (CARD_WIDTH / 2);
            
            const strip = document.getElementById('strip');
            strip.style.transition = "transform 4s cubic-bezier(0.1, 0.9, 0.2, 1)";
            strip.style.transform = `translateX(-${offset}px)`;

            setTimeout(() => {
                isSpinning = false;
                let won = false;
                let multiplier = (winColor === 'green') ? 14 : 2;

                if(choice === winColor) {
                    won = true;
                    const winAmount = bet * multiplier;
                    currentBalance += winAmount;
                    tg.showAlert(`–ü–û–ë–ï–î–ê! +${winAmount}`);
                    tg.HapticFeedback.notificationOccurred('success');
                } else {
                    tg.HapticFeedback.notificationOccurred('error');
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                syncBalance();
                updateUI();

                // –ò—Å—Ç–æ—Ä–∏—è
                const hist = document.getElementById('history');
                const span = document.createElement('span');
                span.innerText = winNum + " ";
                span.style.color = winColor;
                hist.prepend(span);

                setTimeout(() => {
                    strip.style.transition = "none";
                    strip.style.transform = "translateX(0px)";
                    generateStrip();
                }, 1000);

            }, 4000);
        }

        function setMaxBet() { document.getElementById('bet-amount').value = currentBalance; }
        
        function updateUI() {
            document.getElementById('balance').innerText = currentBalance;
            document.getElementById('profile-balance').innerText = currentBalance;
        }

        function switchScreen(name, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${name}`).classList.add('active');
            if(btn) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                btn.classList.add('active');
            }
        }

        // –ó–∞–ø—É—Å–∫        // –ó–∞–ø—É—Å–∫
        initGame();
    </script>
</body>
</html>
